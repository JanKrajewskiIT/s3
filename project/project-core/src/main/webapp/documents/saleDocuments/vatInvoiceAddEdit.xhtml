<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <h:body>
        <ui:composition template="../../layout/main-template.xhtml">
            <ui:define name="content">
                <!-- Right side column. Contains the navbar and content of the page -->
                <aside class="right-side">
                    <!-- Content Header (Page header) -->
                    <section class="content-header">
                        <!--TODO: Łukasz M: Dopracować breadcrumb w wszystkich plikach-->
                        <ol class="breadcrumb">
                            #{vatInvoiceAddEditBean.getCurrentSessionUser(loginBean.userName)}
                            <li><a href="#"><i class="fa fa-laptop"></i>Dokumenty Sprzedaży</a></li>
                            <li class="active">Faktura VAT</li>
                            <li class="active">#{vatInvoiceAddEditBean.breadcrumb}</li>
                        </ol>
                    </section>

                    <!-- Main content -->
                    <section class="content">
                        <div class="row">
                            <div class="col-xs-12">
                                <div class="box">
                                    <div class="box-header">
                                        <h3 class="box-title">#{vatInvoiceAddEditBean.breadcrumb} Fakturę VAT</h3>
                                    </div>
                                    <div class="box-body">
                                        <h:form id="addEditDocumentFormId">
                                            <p:growl id="growl" showDetail="true" />
                                            #{vatInvoiceAddEditBean.setWarehouseId(warehouseGoodsBean.warehouseId)}
                                            <p:messages id="validationMessages" autoUpdate="false"/>
                                            <div class="row" >
                                                <div class="col-xs-4">
                                                    <label>Symbol</label>
                                                    <p:inputText id ="documentSymbolInputText" value="#{vatInvoiceAddEditBean.saleDocumentDTO.symbol}" type="text" styleClass="form-control" placeholder="Wprowadz symbol"/>
                                                    <label>Data Sprzedaży</label>
                                                    <div class="input-group">
                                                        <div class="input-group-addon">
                                                            <i class="fa fa-calendar"></i>
                                                        </div>
                                                        <p:inputMask id ="saleDateInputText" value="#{vatInvoiceAddEditBean.saleDocumentDTO.saleDate}" styleClass="form-control" mask="99/99/9999" placeholder="dd/mm/rrrr">
                                                            <f:convertDateTime pattern="dd/MM/yyyy" timeZone="CET"/>
                                                        </p:inputMask>
                                                    </div>
                                                    <label>Data Wystawienia</label>
                                                    <div class="input-group">
                                                        <div class="input-group-addon">
                                                            <i class="fa fa-calendar"></i>
                                                        </div>
                                                        <p:inputMask id ="documentIssueDate" value="#{vatInvoiceAddEditBean.saleDocumentDTO.documentDate}" styleClass="form-control" mask="99/99/9999" placeholder="dd/mm/rrrr">
                                                            <f:convertDateTime pattern="dd/MM/yyyy" timeZone="CET" />
                                                        </p:inputMask>
                                                    </div><!-- /.input group -->
                                                    <label>Sposób płatności</label>
                                                    <h:selectOneMenu id="paymentMethodMenu" value="#{vatInvoiceAddEditBean.saleDocumentDTO.methodOfPayment.id}" styleClass="form-control">
                                                        <f:selectItems value="#{settingsDocumentsPageBean.paymentMethods}" var="paymentMethod" itemLabel="#{paymentMethod.name}" itemValue="#{paymentMethod.id}"/>
                                                    </h:selectOneMenu>
                                                    <label>Dodaj Towar/Usługe</label>
                                                    <p:autoComplete placeholder="Wprowadź symbol/nazwe" id="symbolAutocomplete" value="#{vatInvoiceAddEditBean.selectedGood}" completeMethod="#{vatInvoiceAddEditBean.completeGood}" minQueryLength="1"
                                                                    var="autoCompleteGood" itemLabel="#{autoCompleteGood.symbol}" itemValue="#{autoCompleteGood}" converter="#{goodDTOConverter}" forceSelection="true">
                                                        <f:facet name="itemtip">
                                                            <h:panelGrid columns="2" cellpadding="5">
                                                                <h:outputText value="Nazwa: " />
                                                                <h:outputText value="#{autoCompleteGood.name}" />

                                                                <h:outputText value="Symbol: " />
                                                                <h:outputText value="#{autoCompleteGood.symbol}" />

                                                                <h:outputText value="Stawka VAT: " />
                                                                <h:outputText value="#{autoCompleteGood.tax.name}" />
                                                            </h:panelGrid>
                                                        </f:facet>
                                                        <p:ajax update="goodTableId,:addEditDocumentFormId:summary" event="blur" listener="#{vatInvoiceAddEditBean.addGoodPositionToDocument()}"/>
                                                    </p:autoComplete>
                                                </div>
                                                <div class="col-xs-4">
                                                    <label>Miejsce Wystawienia</label>
                                                    <p:inputText id ="documentPlaceInputText" value="#{vatInvoiceAddEditBean.saleDocumentDTO.documentPlace}" styleClass="form-control" placeholder="Wprowadz miejsce wystawienia"/>
                                                    <label>Data płatności</label>
                                                    <div class="input-group">
                                                        <div class="input-group-addon">
                                                            <i class="fa fa-calendar"></i>
                                                        </div>
                                                        <p:inputMask id ="paymentDateInputText"  value="#{vatInvoiceAddEditBean.saleDocumentDTO.paymentDate}" styleClass="form-control" mask="99/99/9999" placeholder="dd/mm/rrrr">
                                                            <f:convertDateTime pattern="dd/MM/yyyy" timeZone="CET" />
                                                        </p:inputMask>
                                                    </div>
                                                    <label>Rabat</label>
                                                    <p:inputText id ="disocuntInputText" value="#{vatInvoiceAddEditBean.saleDocumentDTO.discount}" styleClass="form-control">
                                                        <f:convertNumber type="number" groupingUsed="true" minFractionDigits="2" pattern="#0.00" />
                                                    </p:inputText>
                                                    <br/>
                                                    <label >Zapłacono:  </label>
                                                    <h:selectBooleanCheckbox value="#{vatInvoiceAddEditBean.saleDocumentDTO.paid}" />
                                                    <label style="padding-left: 20px">Skutek Magazynowy:  </label>
                                                    <h:selectBooleanCheckbox value="#{vatInvoiceAddEditBean.saleDocumentDTO.warehouseResult}" />
                                                </div>
                                                <div class="col-xs-4">
                                                    <label>Nabywca</label>
                                                    <p:autoComplete placeholder="Wprowadź symbol/nazwe" id="contractorAutocomplete" value="#{vatInvoiceAddEditBean.saleDocumentDTO.contractor}" completeMethod="#{vatInvoiceAddEditBean.completeBuyer}" minQueryLength="1"
                                                                    var="contractor" itemLabel="#{contractor.name}" itemValue="#{contractor}" converter="#{contractorDTOConverter}" forceSelection="true" onselect="" >
                                                        <f:facet name="itemtip">
                                                            <h:panelGrid columns="2" cellpadding="5">

                                                                <h:outputText value="Nazwa: " />
                                                                <h:outputText value="#{contractor.name}" />

                                                                <h:outputText value="Symbol: " />
                                                                <h:outputText value="#{contractor.symbol}" />

                                                                <h:outputText value="Miasto: " />
                                                                <h:outputText value="#{contractor.city}" />

                                                                <h:outputText value="Adres: " />
                                                                <h:outputText value="#{contractor.adress}" />

                                                                <h:outputText value="NIP: " />
                                                                <h:outputText value="#{contractor.nip}" />
                                                            </h:panelGrid>
                                                        </f:facet>
                                                        <p:ajax update="buyerDataTextArea recivedByTextArea disocuntInputText" event="blur"/>
                                                    </p:autoComplete>
                                                    <label>Dane Nabywcy</label>
                                                    <p:inputTextarea id ="buyerDataTextArea" rows="7" value="#{vatInvoiceAddEditBean.buyerToTextAreaString()}" styleClass="form-control" disabled="true"/>
                                                    <label>Symbol Zamówienia</label>
                                                    <p:inputText id ="orderInputText" value="#{vatInvoiceAddEditBean.saleDocumentDTO.orderSymbol}" styleClass="form-control" placeholder="Wprowadz symbol zamówienia"/>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-xs-12">
                                                    <div class="box-body table-responsive" style="padding: 0px; padding-top: 10px">
                                                        <p:dataTable id="goodTableId" var="goodPosition" tableStyleClass="table table-bordered dataTable" value="#{vatInvoiceAddEditBean.goodsPositions}">
                                                            <p:column headerText="Symbol" sortBy="symbol" styleClass="text-left" style="max-width: 300px">
                                                                <h:outputText value="#{goodPosition.good.symbol}" />
                                                            </p:column>
                                                            <p:column headerText="Nazwa" sortBy="name" style="max-width: 450px" styleClass="text-left">
                                                                <h:outputText value="#{goodPosition.good.name}" />
                                                            </p:column>
                                                            <p:column headerText="j.m" sortBy="unit.name" styleClass="text-center">
                                                                <h:outputText value="#{goodPosition.good.unit.name}" />
                                                            </p:column>

                                                            <p:column headerText="VAT" sortBy="tax.value" styleClass="text-center">
                                                                <h:outputText value="#{goodPosition.good.tax.name}" />
                                                            </p:column>

                                                            <p:column headerText="Cena Netto"  style="width: 100px;" sortBy="priceANet" >
                                                                <h:selectOneMenu id="priceNet" value="#{goodPosition.priceNet}" styleClass="form-control" style="width: 120px;">
                                                                    <f:convertNumber type="number" groupingUsed="true" minFractionDigits="2" pattern="#0.00" />
                                                                    <f:selectItem itemLabel="#{goodPosition.good.priceANet}" itemValue="#{goodPosition.good.priceANet}" />
                                                                    <f:selectItem itemLabel="#{goodPosition.good.priceBNet}" itemValue="#{goodPosition.good.priceBNet}"  />
                                                                    <f:selectItem itemLabel="#{goodPosition.good.priceCNet}" itemValue="#{goodPosition.good.priceCNet}" />
                                                                    <p:ajax listener="#{vatInvoiceAddEditBean.priceNetChanged(goodPosition)}" update="priceGross,valueNet,valueGross,:addEditDocumentFormId:summary" />
                                                                </h:selectOneMenu>
                                                            </p:column>

                                                            <p:column headerText="Cena Brutto" style="width: 100px;" sortBy="priceAGross" styleClass="text-right">
                                                                <h:outputText id="priceGross" value="#{goodPosition.priceGross}">
                                                                    <f:convertNumber type="number" groupingUsed="true" minFractionDigits="2" pattern="#0.00" />
                                                                </h:outputText>
                                                            </p:column>

                                                            <p:column headerText="Ilość" style="width: 100px;" sortBy="priceQuantity">
                                                                <p:inputText id="quantity" value="#{goodPosition.quantity}" styleClass="form-control text-right">
                                                                    <f:convertNumber type="number" groupingUsed="true" minFractionDigits="2" pattern="#0.00" />
                                                                    <p:ajax event="blur" listener="#{vatInvoiceAddEditBean.quantityChanged(goodPosition)}" update="valueNet,valueGross,quantity,:addEditDocumentFormId:growl,:addEditDocumentFormId:summary" />
                                                                </p:inputText>
                                                            </p:column>

                                                            <p:column headerText="Wartość Netto" styleClass="text-right">
                                                                <h:outputText id="valueNet" value="#{goodPosition.valueNet}">
                                                                    <f:convertNumber type="number" groupingUsed="true" minFractionDigits="2" pattern="#0.00" />
                                                                </h:outputText>
                                                            </p:column>
                                                            <p:column headerText="Wartość Brutto" styleClass="text-right">
                                                                <h:outputText id="valueGross" value="#{goodPosition.valueGross}">
                                                                    <f:convertNumber type="number" groupingUsed="true" minFractionDigits="2" pattern="#0.00" />
                                                                </h:outputText>
                                                            </p:column>

                                                            <!--                                                     TODO: Łukasz M: Dodać edycje ale z powrotem do strony wystawiania dokumentów.
                                                            <p:column headerText="Akcja" style="width: 155px" styleClass="text-center">
                                                                                                                            <p:commandLink style="margin-right: 10px;" styleClass="btn btn-success btn-xs" action="#{goodAddEditBean.editGood(good.id)}">
                                                                                                                                <i class="glyphicon glyphicon-pencil"></i> Edytuj
                                                                                                                            </p:commandLink>
                                                                                                                            <p:commandLink styleClass="btn btn-danger btn-xs" update="goodTableId" ajax="true" action="#{goodsTableBean.removeGood(good)}">
                                                                                                                                <i class="glyphicon glyphicon-minus"></i> Usuń
                                                                                                                            </p:commandLink>
                                                                                                                        </p:column>-->
                                                        </p:dataTable>
                                                    </div><!-- /.box-body -->
                                                </div>
                                            </div>
                                            <p:panel id="summary">
                                                <div class="row">
                                                    <div class="col-xs-2">
                                                        <label>Suma netto</label>
                                                        <p:inputText id ="totalNetTextArea" value="#{vatInvoiceAddEditBean.totalNet}" styleClass="form-control text-right" disabled="true">
                                                            <f:convertNumber type="number" groupingUsed="true" minFractionDigits="2" pattern="#0.00" />
                                                        </p:inputText>
                                                        <label>Odebrał</label>
                                                        <p:inputText id ="recivedByTextArea" value="#{vatInvoiceAddEditBean.saleDocumentDTO.receivePerson.name}" styleClass="form-control"/>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <label>Suma brutto</label>
                                                        <p:inputText id ="totalGrossTextArea" value="#{vatInvoiceAddEditBean.totalGross}" styleClass="form-control text-right" disabled="true">
                                                            <f:convertNumber type="number" groupingUsed="true" minFractionDigits="2" pattern="#0.00" />
                                                        </p:inputText>
                                                    </div>
                                                    <div class="col-xs-4"/>

                                                    <div class="col-xs-2">
                                                        <label>Zapłacono</label>
                                                        <p:inputText id ="paidTextArea" value="#{vatInvoiceAddEditBean.saleDocumentDTO.paidTotal}" styleClass="form-control text-right">
                                                            <f:convertNumber type="number" groupingUsed="true" minFractionDigits="2" pattern="#0.00" />
                                                        </p:inputText>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <label>Brutto po rabacie</label>
                                                        <p:inputText id ="totalGrossDiscountTextArea" value="#{vatInvoiceAddEditBean.saleDocumentDTO.total}" styleClass="form-control text-right" disabled="true">
                                                            <f:convertNumber type="number" groupingUsed="true" minFractionDigits="2" pattern="#0.00" />
                                                        </p:inputText>
                                                        <label>Wystawił</label>
                                                        <p:inputText id ="issuedByTextArea" value="#{vatInvoiceAddEditBean.saleDocumentDTO.issuePerson.firstName}" styleClass="form-control"/>
                                                    </div>
                                                </div>
                                            </p:panel>
                                            <br/>
                                            <div class="row">
                                                <div class="col-xs-12">
                                                    <p:commandButton value="Zapisz" styleClass="btn btn-primary btn-lg pull-right" action="#{vatInvoiceAddEditBean.saveInvoice()}" update="growl,documentSymbolInputText" />
                                                    <p:commandButton value="Przelicz" styleClass="btn btn-primary btn-lg pull-right" style="margin-right:  10px" update="totalNetTextArea" action="#{vatInvoiceAddEditBean.countTotals()}"/>
                                                    <p:commandButton value="Wyczyść" styleClass="btn btn-primary btn-lg pull-right" style="margin-right:  10px" ajax="true" update="@form" action="#{vatInvoiceAddEditBean.clear()}"/>
                                                </div>
                                            </div>
                                        </h:form>
                                    </div><!-- /.box-body -->
                                </div><!-- /.box -->
                            </div>
                        </div>
                    </section><!-- /.content -->
                </aside><!-- /.right-side -->
            </ui:define>
        </ui:composition>
    </h:body>
</html>

