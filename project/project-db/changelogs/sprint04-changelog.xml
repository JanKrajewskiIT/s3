<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

    <changeSet id="settings_properties_table" author="bartosz.milczarek">
        <createTable tableName="settings">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="settings_pk" />
            </column>
            <column name="property_key" type="VARCHAR(60)">
                <constraints nullable="false" />
            </column>
            <column name="type" type="VARCHAR(15)">
                <constraints nullable="false" />
            </column>
            <column name="key" type="VARCHAR(60)" />
            <column name="value" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
        
        <insert tableName="settings">
            <column name="property_key" value="document.symbol.format" />
            <column name="type" value="SCALAR" />
            <column name="value" value="PREFIKS/NR/RRRR" />
        </insert>
    </changeSet>
    
    <changeSet id="default_value_for_version_methods_of_payment" author="bartosz.milczarek">
        <addDefaultValue tableName="methods_of_payment" columnName="version" defaultValue="1" />
    </changeSet>
    
    <changeSet id="users_table_changes" author="lukasz.gadomski">
        <dropView viewName="auth_view" />
        <dropColumn tableName="users" columnName="login" />
        <sql splitStatements="false">
            CREATE OR REPLACE VIEW AUTH_VIEW AS 
            SELECT U.EMAIL, U.PASSWORD, R.ROLE_NAME 
            FROM USERS U
            INNER JOIN USERS_ROLES UR ON U.USER_ID = UR.USER_ID
            INNER JOIN ROLES R ON UR.ROLE_ID = R.ROLE_ID
            WHERE U.IS_ACTIVE = true;

            GRANT SELECT ON AUTH_VIEW TO glassfish;
            
            CREATE SEQUENCE PENDING_INVITATIONS_SEQ
            START WITH 1
            INCREMENT BY 1
            NO MINVALUE
            NO MAXVALUE
            CACHE 1;

            CREATE TABLE pending_invitations (
            invitation_id INTEGER PRIMARY KEY NOT NULL DEFAULT NEXTVAL('PENDING_INVITATIONS_SEQ'::REGCLASS),
            email CHARACTER VARYING(40) NOT NULL,
            role_id INTEGER NOT NULL REFERENCES ROLES(role_id),
            token VARCHAR(64) NOT NULL,
            creation_date TIMESTAMPTZ NOT NULL
            );

            ALTER TABLE pending_invitations OWNER TO admin;
            ALTER TABLE PENDING_INVITATIONS_SEQ OWNER TO admin;
            ALTER SEQUENCE PENDING_INVITATIONS_SEQ OWNED BY pending_invitations.invitation_id;
            SELECT PG_CATALOG.SETVAL('PENDING_INVITATIONS_SEQ', 1, TRUE);
            
            CREATE TABLE PASSWORD_CHANGE_REQUESTS (
            ID CHARACTER(64) PRIMARY KEY NOT NULL,
            USER_ID BIGINT NOT NULL REFERENCES USERS(USER_ID),
            CREATION_DATE TIMESTAMPTZ NOT NULL
            );

            ALTER TABLE PASSWORD_CHANGE_REQUESTS OWNER TO admin;
        </sql>
    </changeSet>
    
    <changeSet id="goods_adjustment_rev41_42" author="bartosz.milczarek">
        <modifyDataType tableName="goods" columnName="type" newDataType="VARCHAR(10)" />
        <dropNotNullConstraint tableName="goods" columnName="PRICE_B_NET" />
        <dropNotNullConstraint tableName="goods" columnName="PRICE_B_GROSS" />
        <dropNotNullConstraint tableName="goods" columnName="PRICE_C_NET" />
        <dropNotNullConstraint tableName="goods" columnName="PRICE_C_GROSS" />
        <dropNotNullConstraint tableName="goods" columnName="PKWIU" />
        <dropColumn tableName="goods" columnName="photo" />
    </changeSet>
    
    <changeSet id="goods_adjustment_rev41_42_part2" author="bartosz.milczarek">
        <dropNotNullConstraint tableName="goods" columnName="WEIGHT" />
    </changeSet>
    
    <changeSet id="goods_adjustment_rev41_42_part3" author="bartosz.milczarek">
        <dropNotNullConstraint tableName="goods" columnName="description" />
    </changeSet>
    
    <changeSet id="contractors_add_description_column" author="bartosz.milczarek">
        <addColumn tableName="contractors">
            <column name="description" type="TEXT" />
        </addColumn>
    </changeSet>
    
    <changeSet id="contractors_add_is_supplier_column" author="bartosz.milczarek">
        <addColumn tableName="contractors">
            <column name="is_supplier" type="boolean" defaultValue="false" />
        </addColumn>
    </changeSet>
    
    <changeSet id="warehouses_table" author="jan.krajewski">
        <sql>
            CREATE SEQUENCE warehouses_seq
            START WITH 1
            INCREMENT BY 1
            NO MINVALUE
            NO MAXVALUE
            CACHE 1;

            CREATE TABLE warehouses (
            warehouse_id smallint DEFAULT nextval('warehouses_seq'::regclass) NOT NULL,
            warehouse_name character varying(40) NOT NULL,
            warehouse_short_name character varying(4) DEFAULT ''::character varying NOT NULL,
            is_default boolean DEFAULT false NOT NULL,
            version BIGINT NOT NULL
            );

            ALTER TABLE public.warehouses OWNER TO admin;
            ALTER TABLE public.warehouses_seq OWNER TO admin;
            ALTER TABLE ONLY warehouses ADD CONSTRAINT warehouses_pk PRIMARY KEY (warehouse_id);
            CREATE UNIQUE INDEX warehouses_uk ON warehouses USING btree (warehouse_short_name);
        </sql>
    </changeSet>
    <changeSet id="means_of_transport_table" author="jan.krajewski">
        <sql>
            CREATE SEQUENCE means_of_transport_seq
            START WITH 1
            INCREMENT BY 1
            NO MINVALUE
            NO MAXVALUE
            CACHE 1;
            
            CREATE TABLE means_of_transport (
            transport_id smallint DEFAULT nextval('means_of_transport_seq'::regclass) NOT NULL,
            transport_name character varying(40) NOT NULL,
            is_active boolean DEFAULT true NOT NULL,
            version BIGINT NOT NULL
            );
                
            ALTER TABLE public.means_of_transport_seq OWNER TO admin;
            ALTER TABLE public.means_of_transport OWNER TO admin;
            ALTER TABLE ONLY means_of_transport ADD CONSTRAINT means_of_transport_pk PRIMARY KEY (transport_id);
        </sql>
    </changeSet>
    <changeSet id="document_places_tables" author="jan.krajewski">
        <sql>
            CREATE SEQUENCE document_places_seq
            START WITH 1
            INCREMENT BY 1
            NO MINVALUE
            NO MAXVALUE
            CACHE 1;
            
            CREATE TABLE document_places (
            document_place_id smallint DEFAULT nextval('document_places_seq'::regclass) NOT NULL,
            document_place_name character varying(35) NOT NULL,
            is_active boolean DEFAULT true NOT NULL,
            version BIGINT NOT NULL
            );
            
            ALTER TABLE public.document_places_seq OWNER TO admin;
            ALTER TABLE public.document_places OWNER TO admin;
            ALTER TABLE ONLY document_places ADD CONSTRAINT document_places_pk PRIMARY KEY (document_place_id);
        </sql>
    </changeSet>
    <changeSet id="departments_tables" author="jan.krajewski">
        <sql>
            CREATE SEQUENCE departments_seq
            START WITH 1
            INCREMENT BY 1
            NO MINVALUE
            NO MAXVALUE
            CACHE 1;
            
            CREATE TABLE departments (
            department_id smallint DEFAULT nextval('departments_seq'::regclass) NOT NULL,
            department_name character varying(35) NOT NULL,
            is_active boolean DEFAULT true NOT NULL,
            version BIGINT NOT NULL
            );
            
            ALTER TABLE public.departments_seq OWNER TO admin;
            ALTER TABLE public.departments OWNER TO admin;
            ALTER TABLE ONLY departments ADD CONSTRAINT departments_pk PRIMARY KEY (department_id);
        </sql>
    </changeSet>
    <changeSet id="warehouse_documents_table" author="jan.krajewski">
        <sql>
            CREATE TABLE warehouse_documents (
            type character varying(3) NOT NULL,
            symbol character varying(16) NOT NULL,
            contractor_id BIGINT,
            document_place_id smallint DEFAULT (1)::smallint NOT NULL,
            document_date date,
            warehouse_date date, 
            total numeric(10,2) NOT NULL,
            receive_person BIGINT NOT NULL,
            issue_person BIGINT NOT NULL, 
            department_id smallint DEFAULT 0 NOT NULL,
            transport_id smallint DEFAULT (0)::smallint NOT NULL,
            waybill_number character varying(15) DEFAULT ''::character varying NOT NULL, 
            warehouse_result boolean DEFAULT true NOT NULL,
            warehouse_id smallint NOT NULL,
            is_active boolean DEFAULT true NOT NULL,            
            version BIGINT NOT NULL
            );
            
            ALTER TABLE public.warehouse_documents OWNER TO admin;
            ALTER TABLE ONLY warehouse_documents ADD CONSTRAINT warehouse_documents_pk PRIMARY KEY (symbol, warehouse_id);
            ALTER TABLE ONLY warehouse_documents ADD CONSTRAINT warehouse_documents_fk1 FOREIGN KEY (warehouse_id) REFERENCES WAREHOUSES(WAREHOUSE_ID);
            ALTER TABLE ONLY warehouse_documents ADD CONSTRAINT warehouse_documents_fk2 FOREIGN KEY (contractor_id) REFERENCES CONTRACTORS(CONTRACTOR_ID);
            ALTER TABLE ONLY warehouse_documents ADD CONSTRAINT warehouse_documents_fk4 FOREIGN KEY (transport_id) REFERENCES MEANS_OF_TRANSPORT(TRANSPORT_ID);
            ALTER TABLE ONLY warehouse_documents ADD CONSTRAINT warehouse_documents_fk3 FOREIGN KEY (department_id) REFERENCES DEPARTMENTS(DEPARTMENT_ID);
            ALTER TABLE ONLY warehouse_documents ADD CONSTRAINT warehouse_documents_fk5 FOREIGN KEY (document_place_id) REFERENCES DOCUMENT_PLACES(DOCUMENT_PLACE_ID);
            ALTER TABLE ONLY warehouse_documents ADD CONSTRAINT warehouse_documents_fk6 FOREIGN KEY (receive_person) REFERENCES CONTRACTORS(CONTRACTOR_ID);
            ALTER TABLE ONLY warehouse_documents ADD CONSTRAINT warehouse_documents_fk7 FOREIGN KEY (issue_person) REFERENCES users(user_id);
        </sql>
    </changeSet>
    <changeSet id="sale_documents_table" author="jan.krajewski">
        <sql>
            CREATE TABLE sale_documents (
            type character varying(3) NOT NULL,
            symbol character varying(16) NOT NULL,
            contractor_id BIGINT NOT NULL,
            method_of_payment_id BIGINT NOT NULL,
            document_place_id smallint DEFAULT (1)::smallint NOT NULL,
            document_date date NOT NULL,
            sale_date date NOT NULL,
            payment_date date NOT NULL,
            total numeric(10,2) NOT NULL,
            paid numeric(10,2) DEFAULT 0 NOT NULL,
            discount numeric(4,2) DEFAULT 0.00 NOT NULL,
            order_symbol character varying(16) NOT NULL,
            receive_person BIGINT NOT NULL,
            issue_person BIGINT NOT NULL,
            warehouse_result boolean DEFAULT true NOT NULL,
            warehouse_id smallint NOT NULL,
            is_paid boolean DEFAULT true NOT NULL,
            is_active boolean DEFAULT true NOT NULL,            
            version BIGINT NOT NULL
            );

            ALTER TABLE public.sale_documents OWNER TO admin;
            ALTER TABLE ONLY sale_documents ADD CONSTRAINT sale_documents_pk PRIMARY KEY (symbol, warehouse_id);
            ALTER TABLE ONLY sale_documents ADD CONSTRAINT sale_documents_fk1 FOREIGN KEY (warehouse_id) REFERENCES warehouses(warehouse_id);
            ALTER TABLE ONLY sale_documents ADD CONSTRAINT sale_documents_fk2 FOREIGN KEY (contractor_id) REFERENCES CONTRACTORS(CONTRACTOR_ID);
            ALTER TABLE ONLY sale_documents ADD CONSTRAINT sale_documents_fk3 FOREIGN KEY (method_of_payment_id) REFERENCES METHODS_OF_PAYMENT(mop_id);           
            ALTER TABLE ONLY sale_documents ADD CONSTRAINT sale_documents_fk4 FOREIGN KEY (document_place_id) REFERENCES DOCUMENT_PLACES(DOCUMENT_PLACE_ID);
            ALTER TABLE ONLY sale_documents ADD CONSTRAINT sale_documents_fk5 FOREIGN KEY (receive_person) REFERENCES CONTRACTORS(CONTRACTOR_ID);
            ALTER TABLE ONLY sale_documents ADD CONSTRAINT sale_documents_fk6 FOREIGN KEY (issue_person) REFERENCES users(user_id);
        </sql>
    </changeSet>
    <changeSet id="documents_positions_table" author="jan.krajewski">
        <sql>
            CREATE TABLE documents_positions (
            document_symbol character varying(16) NOT NULL,
            good_id BIGINT NOT NULL,
            quantity double precision NOT NULL,
            price_net numeric(10,2) NOT NULL,
            tax_id BIGINT NOT NULL,
            warehouse_id integer DEFAULT 1 NOT NULL,            
            version BIGINT NOT NULL
            );

            ALTER TABLE public.documents_positions OWNER TO admin;
            ALTER TABLE ONLY documents_positions ADD CONSTRAINT documents_positions_pk PRIMARY KEY (warehouse_id, document_symbol, good_id);  
            ALTER TABLE ONLY documents_positions ADD CONSTRAINT documents_positions_fk1 FOREIGN KEY (good_id) REFERENCES goods(good_id);
            ALTER TABLE ONLY documents_positions ADD CONSTRAINT documents_positions_fk2 FOREIGN KEY (tax_id) REFERENCES taxes(tax_id);  
            ALTER TABLE ONLY documents_positions ADD CONSTRAINT documents_positions_fk3 FOREIGN KEY (warehouse_id) REFERENCES warehouses(warehouse_id); 
        </sql>
    </changeSet>
    
</databaseChangeLog>