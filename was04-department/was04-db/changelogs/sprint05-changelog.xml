<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

    <changeSet id="contractors_adjustments" author="bartosz.milczarek">
        <dropColumn tableName="contractors" columnName="additional" />
        <dropColumn tableName="contractors" columnName="source_of_member_id" />
        <dropTable tableName="sources_of_member" />
    </changeSet>
    
    <changeSet id="contractors_adjustments_part_2" author="bartosz.milczarek">
        <modifyDataType tableName="contractors" columnName="name" newDataType="TEXT" />
        <modifyDataType tableName="contractors" columnName="type" newDataType="VARCHAR(10)" />
    </changeSet>
    
    <changeSet id="contractors_adjustments_part_3" author="bartosz.milczarek">
        <dropColumn tableName="contractors" columnName="comments" />
    </changeSet>
    
    <changeSet id="contractors_adjustments_part_4" author="bartosz.milczarek">
        <dropNotNullConstraint tableName="contractors" columnName="nip" />
        <dropNotNullConstraint tableName="contractors" columnName="account_number" />
        <dropNotNullConstraint tableName="contractors" columnName="representative" />
    </changeSet>
    
    <changeSet id="contractors_contacts" author="bartosz.milczarek">
        <sql splitStatements="false">
            CREATE SEQUENCE contractors_contacts_seq
            START WITH 1
            INCREMENT BY 1
            NO MINVALUE
            NO MAXVALUE
            CACHE 1;

            CREATE TABLE contractors_contacts
            (
            contractor_contact_id VARCHAR(24) NOT NULL DEFAULT prefixed_seq('contractors_contacts_seq'::character varying),
            contractor_id VARCHAR(24) NOT NULL,
            name character varying(60) NOT NULL,
            number character varying(20) NOT NULL,
            is_default boolean default false
            );

            ALTER TABLE ONLY contractors_contacts ADD CONSTRAINT contractors_contacts_pk PRIMARY KEY (contractor_contact_id);
            ALTER TABLE CONTRACTORS_CONTACTS ADD CONSTRAINT CONTRACTORS_CONTACTS_FK1 FOREIGN KEY (CONTRACTOR_ID) REFERENCES CONTRACTORS (CONTRACTOR_ID) MATCH FULL;
            SELECT pg_catalog.setval('contractors_contacts_seq', 1, true);
        </sql>
    </changeSet>
    
    <changeSet id="insert_required_default_document_place" author="bartosz.milczarek">
        <insert tableName="settings">
            <column name="property_key" value="document.defaultPlace" />
            <column name="type" value="SCALAR" />
            <column name="value" value="" />
        </insert>
    </changeSet>
    
    <changeSet id="dropped_default_valeus" author="bartosz.milczarek">
        <dropDefaultValue tableName="contractors" columnName="contractor_id" />
        <dropDefaultValue tableName="contractors_contacts" columnName="contractor_contact_id" />
        <dropDefaultValue tableName="contractors_groups" columnName="contractor_group_id" />
        <dropDefaultValue tableName="departments" columnName="department_id" />
        <dropDefaultValue tableName="document_places" columnName="document_place_id" />
        <dropDefaultValue tableName="goods" columnName="good_id" />
        <dropDefaultValue tableName="goods_groups" columnName="good_group_id" />
        <dropDefaultValue tableName="means_of_transport" columnName="transport_id" />
        <dropDefaultValue tableName="methods_of_payment" columnName="mop_id" />
        <dropDefaultValue tableName="taxes" columnName="tax_id" />
        <dropDefaultValue tableName="units" columnName="unit_id" />
        <dropDefaultValue tableName="users" columnName="user_id" />
        <dropDefaultValue tableName="warehouses" columnName="warehouse_id" />
    </changeSet>
    
    <changeSet id="add_default_value_sequence" author="bartosz.milczarek">
        <addDefaultValue tableName="contractors" columnName="contractor_id" defaultValueSequenceNext="contractors_seq" />
        <addDefaultValue tableName="contractors_contacts" columnName="contractor_contact_id" defaultValueSequenceNext="contractors_contacts_seq" />
        <addDefaultValue tableName="contractors_groups" columnName="contractor_group_id" defaultValueSequenceNext="contractors_groups_seq" />
        <addDefaultValue tableName="departments" columnName="department_id" defaultValueSequenceNext="departments_seq" />
        <addDefaultValue tableName="document_places" columnName="document_place_id" defaultValueSequenceNext="document_places_seq" />
        <addDefaultValue tableName="goods" columnName="good_id" defaultValueSequenceNext="goods_seq" />
        <addDefaultValue tableName="goods_groups" columnName="good_group_id" defaultValueSequenceNext="goods_groups_seq" />
        <addDefaultValue tableName="means_of_transport" columnName="transport_id" defaultValueSequenceNext="means_of_transport_seq" />
        <addDefaultValue tableName="methods_of_payment" columnName="mop_id" defaultValueSequenceNext="methods_of_payment_seq" />
        <addDefaultValue tableName="taxes" columnName="tax_id" defaultValueSequenceNext="taxes_seq" />
        <addDefaultValue tableName="units" columnName="unit_id" defaultValueSequenceNext="units_seq" />
        <addDefaultValue tableName="users" columnName="user_id" defaultValueSequenceNext="users_seq" />
        <addDefaultValue tableName="warehouses" columnName="warehouse_id" defaultValueSequenceNext="warehouses_seq" />
    </changeSet>
    
    <changeSet id="sql_changes" author="bartosz.milczarek">
        <sql>
            alter table sale_documents drop column document_place_id;
            alter table sale_documents add column document_place character varying(100);

            alter table warehouse_documents drop column document_place_id;
            alter table warehouse_documents add column document_place character varying(100);
            drop table document_places;

            insert into warehouses values('LDZ0000000000000000001','GÅ‚owny','GL',true,1.0);
            alter table contractors alter column account_number set data type  character varying(50);
        </sql>
    </changeSet>
    
    <changeSet id="wh_goods" author="bartosz.milczarek">
        <sql>
            CREATE TABLE warehouses_goods (
            warehouse character varying (40),
            good character varying (40),
            quantity double precision DEFAULT (0)::double precision,
            is_active boolean DEFAULT true,
            version bigint
            );

            ALTER TABLE ONLY warehouses_goods
            ADD CONSTRAINT wh_goods_warehouse_fkey FOREIGN KEY (warehouse) REFERENCES warehouses(warehouse_id);
	
            ALTER TABLE ONLY warehouses_goods
            ADD CONSTRAINT wh_goods_good_fkey FOREIGN KEY (good) REFERENCES goods(good_id);


            ALTER TABLE ONLY warehouses_goods
            ADD CONSTRAINT wh_goods_pkey PRIMARY KEY (warehouse, good);
	
            CREATE UNIQUE INDEX unique_wh_goods ON warehouses_goods USING btree (warehouse, good);
        </sql>
    </changeSet>
    
    <changeSet id="constraint_check_for_wh_goods_qty" author="bartosz.milczarek">
        <sql>ALTER TABLE warehouses_goods ADD CONSTRAINT quantity_check_not_negative CHECK (quantity >= 0.00);</sql>
    </changeSet>
        
    
    <changeSet id="uniqe_constraints" author="jan.krajewski">
        <sql splitStatements="false">
            alter table users add constraint users_uk unique (email);
            alter table contractors add constraint contractors_uk unique (symbol, is_active);
            alter table contractors_groups add constraint contractors_groups_uk unique (name, is_active);
            alter table departments add constraint departments_uk unique (department_name);
            alter table document_places add constraint document_places_uk unique (document_place_name, is_active);
            alter table goods add constraint goods_uk unique (name, is_active);
            alter table goods_groups add constraint goods_groups_uk unique (name, is_active);
            alter table means_of_transport add constraint means_of_transport_uk(transport_name, is_active);
            alter table methods_of_payment add constraint methods_of_payment_uk unique (name, is_active);
            alter table pending_invitations add constraint pending_invitations_uk unique (email, role_id);
            alter table roles add constraint roles_uk unique(role_name);
            alter table sale_documents add constraint sale_documents_uk unique(symbol, is_active);
            alter table sources_of_member add constraint sources_of_member_uk unique(name, is_active);
            alter table taxes add constraint taxes_uk unique (name, is_active);
            alter table units add constraint units_uk unique (name, is_active);
            alter table warehouse_documents add constraint warehouse_documents_uk unique (symbol, is_active);
            alter table warehouses add constraint warehouses_uk unique (warehouse_name);    
        </sql>
    </changeSet>
</databaseChangeLog>